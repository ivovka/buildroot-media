From 5fe725d196a87807e399a4788c91426f8fc87709 Mon Sep 17 00:00:00 2001
From: Martin van Beurden <chadoe@xbmc.org>
Date: Sun, 8 Jul 2012 15:46:04 +0200
Subject: [PATCH 39/63] restored: paplayer short crossfade on trackskip if
 crossfade is enabled functionality.

---
 xbmc/cores/paplayer/PAPlayer.cpp |   14 ++++++++++++++
 1 file changed, 14 insertions(+)

diff --git a/xbmc/cores/paplayer/PAPlayer.cpp b/xbmc/cores/paplayer/PAPlayer.cpp
index 81203fd..c49863b 100644
--- a/xbmc/cores/paplayer/PAPlayer.cpp
+++ b/xbmc/cores/paplayer/PAPlayer.cpp
@@ -37,6 +37,7 @@
 
 #define TIME_TO_CACHE_NEXT_FILE 5000 /* 5 seconds before end of song, start caching the next song */
 #define FAST_XFADE_TIME           80 /* 80 milliseconds */
+#define MAX_SKIP_XFADE_TIME     2000 /* max 2 seconds crossfade on track skip */
 
 // PAP: Psycho-acoustic Audio Player
 // Supporting all open  audio codec standards.
@@ -233,6 +234,19 @@ bool PAPlayer::OpenFile(const CFileItem& file, const CPlayerOptions &options)
   if (!QueueNextFileEx(file, false))
     return false;
 
+  CSharedLock lock(m_streamsLock);
+  if (m_streams.size() == 2)
+  {
+    //do a short crossfade on trackskip, set to max 2 seconds for these prev/next transitions
+    m_upcomingCrossfadeMS = std::min(m_defaultCrossfadeMS, (unsigned int)MAX_SKIP_XFADE_TIME);
+
+    //start transition to next track
+    StreamInfo* si = m_streams.front();
+    si->m_playNextAtFrame  = si->m_framesSent; //start next track at current frame
+    si->m_prepareTriggered = true; //next track is ready to go
+  }
+  lock.Leave();
+
   if (!IsRunning())
     Create();
 
-- 
1.7.9.4

